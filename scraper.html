<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>BStationX - Auto Sync Hidoristream</title>
    <script src="storage.js"></script>
    <style>
        body{background:#000;color:#fff;font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
        .sync-box{text-align:center;background:#111;padding:40px;border-radius:20px;border:2px solid #ec4899;width:300px}
        .loader {width:40px;height:40px;border:4px solid #333;border-top:4px solid #ec4899;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #log{font-size:12px;color:#666;margin-top:10px}
    </style>
</head>
<body>

<div class="sync-box">
    <div style="font-weight:bold;color:#ec4899;margin-bottom:10px">HIDORISTREAM ENGINE</div>
    <div class="loader"></div>
    <div id="status">Sinkronisasi Video...</div>
    <div id="log">Menghubungkan...</div>
</div>

<script>
async function startSync() {
    const log = document.getElementById('log');
    const status = document.getElementById('status');

    try {
        // Mengambil data HTML dari Hidoristream menggunakan Proxy CORS
        const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://hidoristream.online/'));
        const data = await response.json();
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, 'text/html');
        
        // Mengambil daftar anime terbaru (selector disesuaikan dengan web anime)
        const items = doc.querySelectorAll('.post-item, .item, article'); 
        
        if (items.length === 0) throw new Error("Gagal akses sumber.");

        clearDB(); // Reset data lama agar selalu fresh

        items.forEach((el, index) => {
            if(index >= 50) return; // Ambil 50 terbaru

            const titleEl = el.querySelector('h2, h3, .title, .entry-title');
            const imgEl = el.querySelector('img');
            
            if (titleEl) {
                const title = titleEl.innerText.trim();
                const cover = imgEl ? (imgEl.getAttribute('data-src') || imgEl.src) : '';
                
                // Membuat SLUG (Ujung link video)
                const slug = title.toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .trim()
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');

                // Generate 24 Episode (Hidoristream akan otomatis menampilkan yang sudah rilis)
                const episodes = [];
                for (let i = 1; i <= 24; i++) {
                    episodes.push({
                        number: i,
                        // LINK VIDEO LANGSUNG
                        video: `https://v1.hidoristream.online/embed/${slug}-episode-${i}`
                    });
                }

                addAnime({
                    title: title,
                    cover: cover,
                    description: "Nonton " + title + " Sub Indo terbaru di BStationX.",
                    genres: ["Anime", "Sub Indo"],
                    status: "Ongoing",
                    episodes: episodes
                });

                log.innerText = `Menambahkan: ${title}`;
            }
        });

        status.innerText = "Selesai!";
        setTimeout(() => window.location.href = 'index.html', 1500);

    } catch (err) {
        status.innerText = "Gagal!";
        log.innerText = "Mencoba kembali...";
        setTimeout(startSync, 3000);
    }
}
window.onload = startSync;
</script>
</body>
</html>