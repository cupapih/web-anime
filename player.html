<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>BStationX - Watch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="storage.js"></script>

    <style>
        body{margin:0;background:#000;color:white;font-family:Arial, sans-serif}
        .top{padding:15px;background:#111;display:flex;justify-content:space-between;align-items:center}
        .back{color:#ec4899;cursor:pointer;text-decoration:none;font-weight:bold}
        
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: #000; overflow: hidden; }
        .video-wrapper iframe { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; 
            background: url('https://i.gifer.com/ZKZg.gif') center no-repeat;
        }
        
        .container{padding:20px; max-width: 1000px; margin: auto;}
        .anime-info { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .title{font-size:24px; color:#ec4899; margin: 0 0 10px 0;}
        .synopsis { font-size: 15px; color: #ccc; line-height: 1.6; background: #111; padding: 15px; border-radius: 8px; max-height: 150px; overflow-y: auto;}

        .controls{margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
        .btn-nav { padding:12px 24px; background:#333; border:none; color:white; border-radius:6px; cursor:pointer; font-weight: bold; flex: 1; transition: 0.3s;}
        .btn-nav:hover { background: #444; border: 1px solid #ec4899; }
        .btn-download { padding:12px 24px; background:#22c55e; border:none; color:white; border-radius:6px; cursor:pointer; font-weight: bold; text-decoration: none; display: inline-block; text-align: center;}
        
        .episodes-label { font-weight: bold; margin-bottom: 15px; display: block; color: #ec4899; text-transform: uppercase; font-size: 14px;}
        .episodes{display:grid; grid-template-columns:repeat(auto-fill, minmax(55px, 1fr)); gap:10px}
        .ep{ background:#18181b; padding:12px; text-align:center; cursor:pointer; border-radius:6px; border: 1px solid #333; transition: 0.2s;}
        .ep.active{background:#ec4899; border-color: #ec4899; font-weight: bold; box-shadow: 0 0 10px rgba(236, 72, 153, 0.4);}
        .ep:hover { border-color: #ec4899; background: #222; }
        .status-tag { font-size: 12px; padding: 5px 10px; background: #ec4899; border-radius: 20px; font-weight: bold; letter-spacing: 1px;}
    </style>
</head>
<body>

<div class="top">
    <a class="back" href="index.html">‚Üê Kembali</a>
    <div class="status-tag" id="statusTag">SUB INDO</div>
</div>

<div class="video-wrapper">
    <iframe id="videoPlayer" src="" allowfullscreen 
            sandbox="allow-forms allow-pointer-lock allow-same-origin allow-scripts allow-top-navigation-by-user-activation">
    </iframe>
</div>

<div class="container">
    <div class="anime-info">
        <h2 class="title" id="title">Memuat...</h2>
        <div class="synopsis" id="synopsis">Harap tunggu, sedang mengambil data dari server...</div>
    </div>

    <div class="controls">
        <button class="btn-nav" onclick="prevEp()">‚óÄ Sebelumnya</button>
        <button class="btn-nav" onclick="nextEp()">Berikutnya ‚ñ∂</button>
        <a id="downloadBtn" class="btn-download" target="_blank">üì• Simpan Video</a>
    </div>

    <span class="episodes-label">Daftar Episode:</span>
    <div class="episodes" id="epList"></div>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const animeId = params.get('id'); 
    let epNum = parseInt(params.get('ep')) || 1;
    let currentAnime = null;

    const player = document.getElementById('videoPlayer');
    const downloadBtn = document.getElementById('downloadBtn');

    // FUNGSI BARU: Ambil data dari Cloudflare KV (Asynchronous)
    async function initPlayer() {
        try {
            const db = await getDB(); // Fungsi fetch dari storage.js
            currentAnime = db[animeId];

            if (!currentAnime) {
                alert("Anime tidak ditemukan!");
                location.href = 'index.html';
                return;
            }

            // Update UI
            document.getElementById('title').innerText = currentAnime.title;
            document.getElementById('synopsis').innerText = currentAnime.description || "Tidak ada deskripsi.";
            
            // Putar episode
            playEpisode(epNum);
        } catch (err) {
            console.error(err);
            document.getElementById('synopsis').innerText = "Gagal memuat data dari Cloudflare KV.";
        }
    }

    function playEpisode(n) {
        if (!currentAnime) return;

        const episode = currentAnime.episodes.find(e => e.number == n);
        if (!episode) {
            alert("Episode belum tersedia.");
            return;
        }

        epNum = n;
        document.title = `Nonton ${currentAnime.title} Episode ${n}`;
        
        player.src = "about:blank";
        setTimeout(() => {
            player.src = episode.video;
            downloadBtn.href = episode.video; 
        }, 100);

        renderEpisodes();
        localStorage.setItem('last_watch_' + animeId, n);

        if (window.innerWidth < 768) window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function renderEpisodes() {
        const epList = document.getElementById('epList');
        epList.innerHTML = '';
        
        currentAnime.episodes.forEach(e => {
            const div = document.createElement('div');
            div.className = `ep ${e.number == epNum ? 'active' : ''}`;
            div.innerText = e.number;
            div.onclick = () => playEpisode(e.number);
            epList.appendChild(div);
        });
    }

    function nextEp() { 
        if (currentAnime && epNum < currentAnime.episodes.length) playEpisode(epNum + 1); 
    }

    function prevEp() { 
        if (epNum > 1) playEpisode(epNum - 1); 
    }

    // Jalankan inisialisasi KV
    initPlayer();
</script>

</body>
</html>