<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>BStationX - KV Sync</title>
    <script src="storage.js"></script>
    <style>
        body { background:#000; color:#fff; font-family:sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
        .box { background:#111; padding:30px; border-radius:15px; border:1px solid #ec4899; width:380px; text-align:center; }
        #log { height:150px; overflow-y:auto; background:#050505; color:#888; font-size:11px; padding:10px; margin:15px 0; border-radius:8px; text-align:left; }
        button { background:#ec4899; color:#fff; border:none; padding:12px 25px; border-radius:8px; cursor:pointer; font-weight:bold; }
        .loader { display:none; width:25px; height:25px; border:3px solid #333; border-top:3px solid #ec4899; border-radius:50%; animation:spin 1s linear infinite; margin:10px auto; }
        @keyframes spin { 100% { transform:rotate(360deg); } }
    </style>
</head>
<body>
    <div class="box">
        <h2 style="color:#ec4899; margin:0">KV Sync Engine</h2>
        <p id="status">Database Kosong</p>
        <div class="loader" id="loader"></div>
        <div id="log">Siap sinkronisasi 100 data...</div>
        <button id="btn" onclick="startSync()">START SYNC</button>
    </div>

<script>
async function startSync() {
    const btn = document.getElementById('btn');
    const log = document.getElementById('log');
    const loader = document.getElementById('loader');
    
    btn.style.display = 'none';
    loader.style.display = 'block';
    clearDB();

    try {
        const api = `https://api.bilibili.tv/intl/gateway/web/v2/ogv/index/items?season_type=1&page=1&page_size=100`;
        const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(api)}`);
        const json = await res.json();
        const items = JSON.parse(json.contents).data.items;

        items.forEach((item, i) => {
            const genres = item.styles ? item.styles.map(s => s.name) : ["Ongoing"];
            
            // Logika Embed Otomatis
            const slug = item.title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
            const episodes = [];
            for(let e=1; e<=12; e++) {
                episodes.push({ num: e, url: `https://shironime.com/embed/${slug}-episode-${e}` });
            }

            // SIMPAN KE KV
            saveToKV({
                slug: slug,
                title: item.title,
                cover: item.cover,
                genres: genres,
                desc: item.evaluate || `Nonton ${item.title} Sub Indo.`,
                episodes: episodes
            });

            log.innerHTML = `[${i+1}] KV_STORE: ${slug}<br>` + log.innerHTML;
            document.getElementById('status').innerText = `Tersimpan: ${i+1}/100`;
        });

        log.innerHTML = "<b>SYNC SELESAI!</b><br>" + log.innerHTML;
        setTimeout(() => window.location.href = 'index.html', 1500);

    } catch (e) {
        log.innerHTML = "ERROR: " + e.message;
        btn.style.display = 'block';
    }
}
</script>
</body>
</html>