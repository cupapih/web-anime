<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>BStationX - Pro Scraper 50</title>
    <script src="storage.js" defer></script>
    <style>
        body{background:#0f0f0f;color:white;font-family:Arial, sans-serif;padding:24px}
        .header{display:flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ec4899; padding-bottom: 10px; margin-bottom: 20px;}
        button{padding:12px 24px;background:#ec4899;border:none;color:white;cursor:pointer;font-weight:bold;border-radius:4px; transition: 0.3s;}
        button:hover{background:#be185d; transform: scale(1.02);}
        button:disabled{background:#555;cursor:not-allowed}
        pre{background:#000;padding:15px;margin-top:12px;border:1px solid #333;font-size:12px;color:#adff2f; height: 400px; overflow-y: auto; border-radius: 8px;}
        .stats { font-size: 14px; color: #aaa; }
    </style>
</head>
<body>

    <div class="header">
        <h2>BStationX - Auto Sync (Top 50)</h2>
        <div class="stats" id="statsText">Database: Menunggu...</div>
    </div>

    <p>Mengambil 50 anime terbaru yang sedang tayang atau baru saja diperbarui.</p>
    <button id="runBtn">MULAISYNC 50 ANIME</button>
    
    <pre id="log">Status: Klik tombol di atas untuk sinkronisasi data.</pre>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const log = document.getElementById('log');
        const runBtn = document.getElementById('runBtn');
        const statsText = document.getElementById('statsText');

        // Fungsi untuk update status jumlah data di storage
        const updateStats = () => {
            const db = typeof getDB === 'function' ? getDB() : [];
            statsText.textContent = `Database: ${db.length} Anime tersimpan`;
        };
        updateStats();

        runBtn.addEventListener('click', async () => {
            if(!confirm("Hapus data lama dan ambil 50 anime terbaru?")) return;
            
            runBtn.disabled = true;
            log.textContent = 'üöÄ Memulai proses sinkronisasi...\n';
            log.textContent += 'üßπ Membersihkan database lama...\n';
            
            if (typeof clearDB === 'function') clearDB();

            // QUERY: perPage diset ke 50, diurutkan berdasarkan UPDATED_AT_DESC (Terbaru update)
            const query = `
            query {
              Page(perPage: 50) { 
                media(type: ANIME, status_in: [RELEASING, FINISHED], sort: UPDATED_AT_DESC) {
                  title { romaji, english }
                  coverImage { large }
                  status
                  episodes
                }
              }
            }`;

            try {
                log.textContent += 'üì° Menghubungi Server AniList...\n';
                const res = await fetch('https://graphql.anilist.co', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                if(!res.ok) throw new Error("Gagal mengambil data dari server.");

                const json = await res.json();
                const animeList = json.data.Page.media;

                animeList.forEach((a, index) => {
                    const mainTitle = a.title.romaji || a.title.english;
                    
                    // Logic Video: Menggunakan pemutar multi-embed otomatis
                    const videoUrl = `https://multiembed.mov/directstream.php?video_id=${encodeURIComponent(mainTitle)}&type=anime`;

                    if (typeof addAnime === 'function') {
                        addAnime({
                            title: mainTitle,
                            cover: a.coverImage.large,
                            status: a.status === 'RELEASING' ? 'Ongoing' : 'Tamat',
                            episodes: [
                                { 
                                    title: "Episode Terbaru", 
                                    url: videoUrl 
                                }
                            ]
                        });
                    }
                    
                    log.textContent += `[${index + 1}] Berhasil Sync: ${mainTitle}\n`;
                    // Auto scroll log ke bawah
                    log.scrollTop = log.scrollHeight;
                });

                log.textContent += '\n‚úÖ SELESAI! 50 Anime terbaru siap ditonton.';
                updateStats();

            } catch(err) {
                log.textContent += `\n‚ùå ERROR: ${err.message}`;
            } finally {
                runBtn.disabled = false;
            }
        });
    });
    </script>
</body>
</html>