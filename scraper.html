<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Scraper</title>
    <script src="storage.js" defer></script>
    <style>
        body{background:#0f0f0f;color:white;font-family:Arial;padding:24px}
        button{padding:12px;background:#ec4899;border:none;color:white;cursor:pointer;font-weight:bold}
        button:disabled{background:#555;cursor:not-allowed}
        pre{background:black;padding:12px;margin-top:12px;white-space: pre-wrap;word-wrap: break-word;border: 1px solid #333}
    </style>
</head>
<body>

    <h2>AniList Auto Scraper</h2>
    <button id="runBtn">RUN SCRAPER (SYNC DATA)</button>
    <pre id="log">Siap melakukan scraping...</pre>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const log = document.getElementById('log');
        const runBtn = document.getElementById('runBtn');
        let isRunning = false;

        runBtn.addEventListener('click', async () => {
            if(isRunning) return;

            // Memastikan fungsi dari storage.js sudah terbaca
            if (typeof clearDB !== 'function' || typeof addAnime !== 'function') {
                log.textContent = 'Error: storage.js belum dimuat. Refresh halaman (Ctrl+F5).';
                return;
            }

            // 1. SOLUSI BIAR TIDAK DOUBLE: Hapus data lama sebelum isi baru
            if(!confirm("Hapus daftar lama dan ambil data terbaru?")) return;

            isRunning = true;
            runBtn.disabled = true;
            log.textContent = 'Membersihkan database lama...\n';
            clearDB(); // Menghapus data di localStorage agar tidak menumpuk

            log.textContent += 'Mengambil data dari AniList...\n';

            const query = `
            query {
              Page(perPage: 12) {
                media(type: ANIME, sort: POPULARITY_DESC) {
                  title { romaji }
                  coverImage { large }
                  status
                }
              }
            }`;

            try {
                const res = await fetch('https://graphql.anilist.co',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({query})
                });

                if(!res.ok) throw new Error('Gagal terhubung ke AniList');

                const json = await res.json();
                const animeList = json.data.Page.media;

                animeList.forEach((a, index) => {
                    // 2. SOLUSI BIAR BISA DI-PLAY: Mengisi array episodes
                    // AniList tidak punya video, jadi kita beri link contoh (dummy) dulu
                    addAnime({
                        title: a.title.romaji,
                        cover: a.coverImage.large,
                        status: a.status,
                        episodes: [
                            { 
                                title: "Episode 01", 
                                url: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8" 
                            }
                        ]
                    });
                    log.textContent += `[${index + 1}] Berhasil: ${a.title.romaji}\n`;
                });

                log.textContent += '\nSELESAI âœ“ Cek halaman utama.';
            } catch(err) {
                log.textContent = 'Error: ' + err.message;
            } finally {
                isRunning = false;
                runBtn.disabled = false;
            }
        });
    });
    </script>
</body>
</html>