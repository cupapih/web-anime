<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>BStationX - Fix Sync</title>
    <script src="storage.js"></script>
    <style>
        body{background:#000;color:#fff;font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
        .sync-card{text-align:center;background:#111;padding:40px;border-radius:20px;border:2px solid #ec4899;width:350px}
        .loader{width:40px;height:40px;border:4px solid #333;border-top:4px solid #ec4899;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #log{font-size:12px;color:#666;margin-top:10px;height:40px;overflow:hidden}
        button{background:#ec4899;border:none;color:white;padding:10px 20px;border-radius:5px;cursor:pointer;font-weight:bold;margin-top:10px}
    </style>
</head>
<body>

<div class="sync-card">
    <div style="font-weight:bold;color:#ec4899">HIDORISTREAM FIX ENGINE</div>
    <div class="loader" id="loader"></div>
    <div id="status">Mensinkronkan Data...</div>
    <div id="log">Menyiapkan database...</div>
    <button id="retryBtn" style="display:none" onclick="location.reload()">Coba Lagi</button>
</div>

<script>
async function runFixSync() {
    const log = document.getElementById('log');
    const status = document.getElementById('status');
    const loader = document.getElementById('loader');
    const retryBtn = document.getElementById('retryBtn');

    try {
        // Menggunakan Jikan API (Tanpa Proxy) untuk ambil list anime ongoing terbaru
        // Ini jauh lebih stabil daripada scraping HTML langsung yang sering diblokir
        const res = await fetch('https://api.jikan.moe/v4/seasons/now?limit=25');
        const data = await res.json();
        
        if(!data.data) throw new Error("API Limit");

        clearDB(); // Hapus data lama

        data.data.forEach((anime) => {
            const title = anime.title;
            const cover = anime.images.jpg.large_image_url;
            
            // Generate Slug Hidoristream secara akurat
            const slug = title.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .trim()
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');

            const episodes = [];
            // Buat 12 episode awal (Hidoristream akan isi videonya otomatis)
            for(let ep = 1; ep <= 12; ep++) {
                episodes.push({
                    number: ep,
                    video: `https://v1.hidoristream.online/embed/${slug}-episode-${ep}`
                });
            }

            addAnime({
                title: title,
                cover: cover,
                description: anime.synopsis || "Nonton anime Sub Indo terbaru.",
                genres: anime.genres.map(g => g.name),
                status: "Ongoing",
                episodes: episodes
            });
            log.innerText = `Berhasil: ${title}`;
        });

        status.innerText = "Selesai!";
        loader.style.display = 'none';
        setTimeout(() => window.location.href = 'index.html', 1000);

    } catch (e) {
        status.innerText = "Gagal (API Limit)";
        log.innerText = "Terlalu banyak request. Tunggu 1 menit lalu klik Coba Lagi.";
        loader.style.display = 'none';
        retryBtn.style.display = 'inline-block';
    }
}
window.onload = runFixSync;
</script>
</body>
</html>