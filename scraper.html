<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>BStationX - Manual Sync</title>

<!-- PENTING: PATH EKSPLISIT -->
<script src="./storage.js"></script>

<style>
body{
  background:#000;color:#fff;font-family:sans-serif;
  display:flex;justify-content:center;align-items:center;
  height:100vh;margin:0
}
.sync-card{
  text-align:center;background:#111;padding:40px;
  border-radius:20px;border:2px solid #ec4899;width:420px
}
.loader{
  display:none;
  width:40px;height:40px;border:4px solid #333;
  border-top:4px solid #ec4899;border-radius:50%;
  animation:spin 1s linear infinite;margin:20px auto
}
@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}
#log{
  font-size:12px;color:#aaa;margin-top:15px;
  height:100px;overflow-y:auto;text-align:left
}
button{
  background:#ec4899;color:#000;
  border:none;padding:10px 18px;
  font-weight:bold;border-radius:8px;
  cursor:pointer
}
</style>
</head>

<body>

<div class="sync-card">
  <div style="font-weight:bold;color:#ec4899;font-size:1.2rem">
    BStationX – Manual Sync
  </div>

  <div class="loader" id="loader"></div>

  <div id="status">Siap melakukan sinkronisasi</div>

  <button onclick="startSync()">Mulai Sync</button>

  <div id="log">Menunggu perintah...</div>
</div>

<script>
/* === VALIDASI STORAGE (ANTI GAGAL) === */
if (typeof clearDB !== "function" || typeof addAnime !== "function") {
  document.getElementById("status").innerText =
    "storage.js tidak ter-load";
  throw new Error("storage.js missing");
}

/* === SYNC FUNCTION === */
async function startSync() {
  const log = document.getElementById("log");
  const status = document.getElementById("status");
  const loader = document.getElementById("loader");

  loader.style.display = "block";
  log.innerHTML = "";
  status.innerText = "Menghapus data lama...";
  clearDB();

  let total = 0;

  try {
    for (let page = 1; page <= 5; page++) {
      status.innerText = `Mengambil halaman ${page}...`;

      const res = await fetch(`/api/ongoing?page=${page}`);
      if (!res.ok) throw new Error("API error");

      const data = await res.json();
      const list = data?.animeList || [];

      for (const item of list) {
        if (total >= 100) break;

        const episodes = [];
        for (let i = 1; i <= 24; i++) {
          episodes.push({
            number: i,
            video: `https://shironime.com/embed/${item.id}-episode-${i}`
          });
        }

        addAnime({
          title: item.title,
          cover: item.thumb,
          description: `Nonton ${item.title} Subtitle Indonesia.`,
          genres: ["Ongoing", "Sub Indo"],
          status: "Currently Airing",
          episodes
        });

        total++;
        log.innerHTML =
          `✔ ${item.title}<br>` + log.innerHTML;
      }
    }

    loader.style.display = "none";
    status.innerText = `Selesai! ${total} anime tersimpan`;

    console.log("DB FINAL:", getDB());

    setTimeout(() => {
      window.location.href = "index.html";
    }, 1500);

  } catch (e) {
    loader.style.display = "none";
    status.innerText = "Gagal sinkronisasi";
    log.innerText = e.message;
  }
}
</script>

</body>
</html>
