<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title> SEINSNIME Scraper</title>
    <script src="storage.js" defer></script>
    <style>
        body{background:#0f0f0f;color:white;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;padding:30px;line-height:1.6}
        .card{background:#18181b;padding:25px;border-radius:12px;border:1px solid #333;max-width:800px;margin:auto;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
        h2{color:#ec4899;margin-top:0;display:flex;align-items:center;gap:10px}
        p{color:#aaa;font-size:14px}
        button{width:100%;padding:15px;background:#ec4899;border:none;color:white;cursor:pointer;font-weight:bold;border-radius:8px;font-size:16px;transition:0.3s;margin-top:10px}
        button:hover{background:#be185d;transform:translateY(-2px)}
        button:disabled{background:#444;cursor:not-allowed;transform:none}
        #log{background:#000;padding:15px;margin-top:20px;border:1px solid #444;font-family:monospace;font-size:12px;color:#adff2f;height:250px;overflow-y:auto;border-radius:6px;display:none}
        .status-bar{margin-top:15px;font-size:13px;display:flex;justify-content:space-between;color:#ec4899}
    </style>
</head>
<body>

<div class="card">
    <h2>üöÄ BStationX Auto Sync</h2>
    <p>Sistem akan menarik 50 data anime terbaru dari AniList, mencocokkan link video streaming, dan menyimpan sinopsis serta genre secara otomatis.</p>
    
    <button id="runBtn">MULAI SYNC DATA TERBARU</button>
    
    <div class="status-bar">
        <span id="progress">Status: Ready</span>
        <span id="count">Total: 0</span>
    </div>

    <pre id="log"></pre>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const log = document.getElementById('log');
    const runBtn = document.getElementById('runBtn');
    const progressText = document.getElementById('progress');
    const countText = document.getElementById('count');

    // Menampilkan jumlah data saat ini
    const updateCount = () => {
        const db = typeof getDB === 'function' ? getDB() : [];
        countText.textContent = `Total: ${db.length} Anime`;
    };
    updateCount();

    runBtn.addEventListener('click', async () => {
        if(!confirm("Hapus data lama dan sinkronkan 50 anime terbaru?")) return;

        runBtn.disabled = true;
        log.style.display = 'block';
        log.textContent = 'ÂàùÊúüÂåñ (Initializing)...\n';
        
        if (typeof clearDB === 'function') clearDB();
        progressText.textContent = 'Status: Cleaning...';

        // QUERY FINAL: Mengambil data lengkap
        const query = `
        query {
          Page(perPage: 50) { 
            media(type: ANIME, status_in: [RELEASING, FINISHED], sort: UPDATED_AT_DESC) {
              title { romaji, english }
              coverImage { large }
              description
              genres
              status
              episodes
            }
          }
        }`;

        try {
            log.textContent += 'üì° Menghubungi Server AniList...\n';
            const res = await fetch('https://graphql.anilist.co', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });

            const json = await res.json();
            const animeList = json.data.Page.media;

            animeList.forEach((a, index) => {
                const title = a.title.romaji || a.title.english;
                progressText.textContent = `Status: Syncing (${index + 1}/50)`;

                // LOGIKA VIDEO & DOWNLOAD:
                // Menggunakan Direct Stream Embed agar bisa diputar di player kamu
                const videoSource = `https://multiembed.mov/directstream.php?video_id=${encodeURIComponent(title)}&type=anime`;

                if (typeof addAnime === 'function') {
                    addAnime({
                        title: title,
                        cover: a.coverImage.large,
                        // Membersihkan sinopsis dari tag HTML
                        description: a.description ? a.description.replace(/<\/?[^>]+(>|$)/g, "") : "No synopsis available.",
                        genres: a.genres || ["Action"],
                        status: a.status === 'RELEASING' ? 'Ongoing' : 'Completed',
                        episodes: [
                            { 
                                number: 1, 
                                title: "Episode 01", 
                                video: videoSource // Ini yang dipanggil di player.html
                            }
                        ]
                    });
                }
                
                log.textContent += `[SUCCESS] ${title}\n`;
                log.scrollTop = log.scrollHeight;
            });

            log.textContent += '\n‚úÖ SEMUA DATA BERHASIL DISIMPAN!';
            progressText.textContent = 'Status: Finished ‚úì';
            updateCount();

        } catch(err) {
            log.textContent += `\n‚ùå ERROR: ${err.message}`;
            progressText.textContent = 'Status: Failed';
        } finally {
            runBtn.disabled = false;
        }
    });
});
</script>

</body>
</html>