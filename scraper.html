<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Hidoristream Scraper - Fixed</title>
    <script src="storage.js" defer></script>
    <style>
        body{background:#0f0f0f;color:white;font-family:Arial;padding:24px}
        button{padding:12px;background:#00b4d8;border:none;color:white;cursor:pointer;font-weight:bold;border-radius:4px}
        button:disabled{background:#555;cursor:not-allowed}
        pre{background:black;padding:12px;margin-top:12px;white-space: pre-wrap;word-wrap: break-word;border: 1px solid #333;font-size:12px;color: #adff2f}
    </style>
</head>
<body>

    <h2>Hidoristream Auto Sync (CORS Fixed)</h2>
    <p>Status: Menggunakan Proxy untuk menembus blokir CORS.</p>
    <button id="runBtn">SYNC SEKARANG</button>
    <pre id="log">Siap...</pre>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const log = document.getElementById('log');
        const runBtn = document.getElementById('runBtn');
        let isRunning = false;

        runBtn.addEventListener('click', async () => {
            if(isRunning) return;
            if (typeof addAnime !== 'function') return alert("storage.js belum siap!");

            isRunning = true;
            runBtn.disabled = true;
            log.textContent = 'Menembus blokir CORS dan mengambil data...\n';
            
            if(confirm("Hapus data lama sebelum update?")) clearDB();

            // Menggunakan Proxy gratis untuk menghindari error CORS
            const proxy = 'https://api.allorigins.win/get?url=';
            const targetUrl = encodeURIComponent('https://v1.hidoristream.online/api/anime/terbaru');

            try {
                const response = await fetch(proxy + targetUrl);
                if (!response.ok) throw new Error("Gagal menghubungi Proxy.");
                
                const rawData = await response.json();
                // Data dari allorigins dibungkus dalam properti 'contents'
                const result = JSON.parse(rawData.contents);

                const listAnime = result.data || result;

                if (!listAnime || listAnime.length === 0) {
                    throw new Error("Data anime kosong atau struktur API berubah.");
                }

                listAnime.forEach((item, index) => {
                    addAnime({
                        title: item.title || "Unknown Title",
                        cover: item.poster || item.thumbnail || "https://via.placeholder.com/300",
                        status: item.status || "Ongoing",
                        episodes: [
                            {
                                title: "Episode " + (item.last_episode || "Terbaru"),
                                url: item.video_url || `https://v1.hidoristream.online/embed/${item.slug || ''}`
                            }
                        ]
                    });
                    log.textContent += `[OK] Berhasil: ${item.title}\n`;
                });

                log.textContent += '\nâœ“ BERHASIL! Silakan cek halaman utama.';
            } catch (err) {
                log.textContent += '\n[GAGAL] Masalah: ' + err.message;
                log.textContent += '\nSaran: Pastikan link API Hidoristream masih aktif.';
                console.error(err);
            } finally {
                isRunning = false;
                runBtn.disabled = false;
            }
        });
    });
    </script>
</body>
</html>